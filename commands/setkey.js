const Discord = require('discord.js');

module.exports = {
	name: 'setkey',
	aliases: ['setkey'],
	description: "Change a players key",
    usage: '<@Username/Username> <New Key>',
    moderatorsOnly: true,
    ownerOnly: true,
	guildOnly: true,
	cooldown: 3,
	run(client, msg, args, con) {
        if(args[0] && args[1]) {
            var taggedUser = msg.mentions.users.first();
            //if (!taggedUser) taggedUser = msg.guild.members.cache.get(args[0]);
            var UserId;
            const newUniqueCode = args[1].replace(/[^\w\s]/gi, '')
            if(newUniqueCode.length < 5) {
                msg.channel.send(`New key needs to be atleast 5 characters`);
                return;
            }
            if (taggedUser) {
                con.query("SELECT `id` FROM `Users` WHERE `DiscordID` = '" + taggedUser.id + "' LIMIT 1", function (err, result) {
                    if (result.length) { 
                        msg.channel.send(`Set ${taggedUser.username}'s key to: ${newUniqueCode}`);
                        con.query("UPDATE `Users` SET `UniqueCode` = '" + newUniqueCode + "' WHERE `id` = '" + result[0].id + "'", function (err, result) { if (err) console.log(err); });
                    } else { 
                        msg.channel.send(`User is not linked to an account`);
                        return;
                    }
                });
            } else {
                con.query("SELECT `id`,`Username` FROM `Users` WHERE `Username` = '" + args[0] + "' LIMIT 1", function (err, result) {
                    if (result.length) { 
                        msg.channel.send(`Set ${result[0].Username}'s rank to: ${newUniqueCode}`);
                        con.query("UPDATE `Users` SET `UniqueCode` = '" + newUniqueCode + "' WHERE `id` = '" + result[0].id + "'", function (err, result) { if (err) console.log(err); });
                    } else { 
                        msg.channel.send(`User not found`);
                        return;
                    }
                });
            }
        } else { msg.channel.send(`You need to include a username and new rank. $setrank <@Username/Username> <New Rank>`); }
        // } else { msg.channel.send(`You need to have the tester rank for this!`); }
	},
};


