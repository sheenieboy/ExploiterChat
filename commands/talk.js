const Discord = require('discord.js');
const moment = require('moment')
require("dotenv").config()
const webhook = new Discord.WebhookClient("810596684542509096", "FrfU-2vbvWLC7_kDECrCFg6qKuxJ7rkIqa2Wnt7IhX0WcB7WwQbcT0d7-uEOK_zvyeJ5");
const devWebhook = new Discord.WebhookClient("810591898254835780", "OF1iRXBZTrmHa6XQlbp6nssS2aoqdW_yw067UvGLdGCf6_Oq2X18yNs2QKBXW4cwxUpO");

module.exports = {
    name: 'talk',
    aliases: ['talk'],
    description: "test",
    usage: '', //'<@Username> <Message>',
    moderatorsOnly: false,
    ownerOnly: true, 
    guildOnly: true,
    cooldown: 3,
    run(client, message, args, con) {

        var userMessage = args[1];
        for (i = 2; i < args.length; i++) {
            if(args[i]) {
                userMessage = userMessage + " " + args[i];
            }
        }

        var taggedUser = message.mentions.members.first();
        if (!taggedUser) {
            if(message.guild.members.cache.get(args[0])) {
                taggedUser = message.guild.members.cache.get(args[0]);
            }
        }
        if(taggedUser) {
            con.query("SELECT * FROM `Users` WHERE `DiscordID` = '" + taggedUser.id + "'", function (err, discordC) {
                if(discordC.length) {
                    var useName = discordC[0].Username;
                    if(discordC[0].Nickname != "None") {
                        useName = discordC[0].Nickname;
                    }

                    var useThisUsername = useName;
                    if(taggedUser.user.username == useName) {
                        useThisUsername += `#${taggedUser.user.discriminator}`;
                    } else {
                        useThisUsername += ` - ${taggedUser.user.username}#${taggedUser.user.discriminator}`;
                    }
                    var useThisID = discordC[0].UserId || 1;
                    if(process.env.DEV_VERSION == "true") {
                        devWebhook.send(userMessage, {'username': useThisUsername, "disableMentions": "all", "avatarURL": `https://www.roblox.com/headshot-thumbnail/image?userId=${useThisID}&width=100&height=100&format=png`});
                    } else {
                        webhook.send(userMessage, {'username': useThisUsername, "disableMentions": "all", "avatarURL": `https://www.roblox.com/headshot-thumbnail/image?userId=${useThisID}&width=100&height=100&format=png`});
                    }
                    global.WebSocket.clients.forEach(function each(client) {
                        client.send(JSON.stringify({'Username': useName, 'Rank': discordC[0].Rank, 'Message': global.Encrypt(userMessage).replace(/[\[\]&]+/g, '')}));
                    })
                }
            });
        } else {
            con.query("SELECT * FROM `Users` WHERE `Username` = '" + args[0] + "'", function (err, discordC) {
                if(discordC.length) {
                    var useName = discordC[0].Username;
                    if(discordC[0].Nickname != "None") {
                        useName = discordC[0].Nickname;
                    }

                    var useThisUsername = useName;
                    var getUser = message.guild.members.cache.get(discordC[0].DiscordID);
                    if(getUser) {
                        if(getUser.user.username == useName) {
                            useThisUsername += `#${getUser.user.discriminator}`;
                        } else {
                            useThisUsername += ` - ${getUser.user.username}#${getUser.user.discriminator}`;
                        }
                    }

                    var useThisID = discordC[0].UserId || 1;
                    if(process.env.DEV_VERSION == "true") {
                        devWebhook.send(userMessage, {'username': useThisUsername, "disableMentions": "all", "avatarURL": `https://www.roblox.com/headshot-thumbnail/image?userId=${useThisID}&width=100&height=100&format=png`});
                    } else {
                        webhook.send(userMessage, {'username': useThisUsername, "disableMentions": "all", "avatarURL": `https://www.roblox.com/headshot-thumbnail/image?userId=${useThisID}&width=100&height=100&format=png`});
                    }
                    global.WebSocket.clients.forEach(function each(client) {
                        client.send(JSON.stringify({'Username': useName, 'Rank': discordC[0].Rank, 'Message': global.Encrypt(userMessage).replace(/[\[\]&]+/g, '')}));
                    })
                }
            });
        }
    }
};